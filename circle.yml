version: 2.1
orbs:
  # https://github.com/cypress-io/circleci-orb
  cypress: cypress-io/cypress@1.29.0

parameters:
  GREP_TAGS:
    type: enum
    enum: [
        '',
        # a single main test for each feature
        '@sanity',
        '@adding',
        '@complete',
        '@editing',
        '@item',
        '@persistence',
        '@routing',
        # a superset of @sanity tests
        '@regression',
      ]
    default: ''
  MACHINES:
    description: The number of parallel machines to use
    type: string
    default: 1

workflows:
  nightly:
    triggers:
      - schedule:
          cron: '0 0 * * *'
          filters:
            branches:
              only:
                - master

    jobs:
      - cypress/run:
          name: Run all tests
          build: npm run print-tests
          start: npm start
          no-workspace: true

  tagged:
    when: << pipeline.parameters.GREP_TAGS >>
    jobs:
      - cypress/run:
          name: Run tagged tests
          build: npm run print-tests
          start: npm start
          no-workspace: true
          env: grepTags=<< pipeline.parameters.GREP_TAGS >>

  build:
    unless: << pipeline.parameters.GREP_TAGS >>
    jobs:
      - cypress/run:
          name: Run changed tests
          start: npm start
          no-workspace: true
          command: |
            # stop if on master branch - all tests should run there
            if [ "$CIRCLE_BRANCH" = "master" ]; then
              echo "Default branch, will run all tests"
              exit 0
            fi

            # be careful about counting the lines
            specsLines=$(git diff --name-only --diff-filter=AMR origin/master | { grep cypress/integration || true; })
            n=$(echo $specsLines | sed '/^\s*$/d' | wc -l | tr -d ' ')
            specs=$(echo $specsLines | sed '/^\s*$/d' | tr '\n' ',')
            echo ""
            echo "Changed and added ${n} Cypress specs"
            echo ${specs}
            echo ""
            if [ ${n} -lt 1 ]; then
              echo "No Cypress specs changed, exiting..."
              exit 0
            fi
            # we have to form the Cypress run command ourselves
            npx cypress run --spec ${specs}

      - cypress/run:
          name: Run sanity tests
          requires:
            - Run changed tests
          build: npm run print-tests
          start: npm start
          no-workspace: true
          env: grepTags=@sanity
